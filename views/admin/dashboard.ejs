<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-icon">ğŸ“…</div>
        <div class="stat-info">
            <p class="stat-value"><%= stats.todayCount %></p>
            <p class="stat-label">RDV aujourd'hui</p>
        </div>
    </div>
    <div class="stat-card stat-card--warning">
        <div class="stat-icon">â³</div>
        <div class="stat-info">
            <p class="stat-value"><%= stats.pendingCount %></p>
            <p class="stat-label">En attente</p>
        </div>
    </div>
    <div class="stat-card stat-card--info">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-info">
            <p class="stat-value"><%= stats.clientCount %></p>
            <p class="stat-label">Total clients</p>
        </div>
    </div>
    <div class="stat-card stat-card--success">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-info">
            <p class="stat-value"><%= parseFloat(stats.monthRevenue).toFixed(0) %>â‚¬</p>
            <p class="stat-label">CA du mois</p>
        </div>
    </div>
</div>

<% if (reminders && reminders.length > 0) { %>
<div class="reminder-panel">
    <div class="reminder-header">
        <h3>ğŸ”” Rappels â€” RDV aujourd'hui/demain (<%= reminders.length %>)</h3>
    </div>
    <div class="reminder-list">
        <% const today = new Date().toISOString().split('T')[0]; %>
        <% reminders.forEach(r => { %>
        <div class="reminder-card">
            <div class="reminder-info">
                <div class="reminder-icon"><%= r.service_icon %></div>
                <div>
                    <strong><%= r.first_name %> <%= r.last_name %></strong>
                    <span class="reminder-service"><%= r.service_name %></span>
                    <span class="reminder-date">
                        <%= r.booking_date.toISOString().split('T')[0] === today ? "Aujourd'hui" : 'Demain' %>
                        â€” <%= timeSlotLabels[r.time_slot] || r.time_slot %>
                    </span>
                </div>
            </div>
            <div class="reminder-actions">
                <a href="tel:<%= r.phone %>" class="btn btn-sm btn-success" title="Appeler">ğŸ“ Appeler</a>
                <a href="/admin/bookings/<%= r.id %>" class="btn btn-sm">Voir</a>
                <form method="POST" action="/admin/bookings/<%= r.id %>/dismiss-reminder" style="display:inline;">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="btn btn-sm">âœ“ Acquitter</button>
                </form>
            </div>
        </div>
        <% }) %>
    </div>
</div>
<% } %>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>RÃ©servations (30 derniers jours)</h3>
        <canvas id="bookingsChart" height="200"></canvas>
    </div>

    <div class="dashboard-card">
        <h3>Prochains rendez-vous</h3>
        <% if (upcoming.length === 0) { %>
        <p class="empty-state">Aucun rendez-vous Ã  venir</p>
        <% } else { %>
        <div class="upcoming-list">
            <% upcoming.forEach(b => { %>
            <a href="/admin/bookings/<%= b.id %>" class="upcoming-item">
                <div class="upcoming-icon"><%= b.service_icon %></div>
                <div class="upcoming-info">
                    <strong><%= b.first_name %> <%= b.last_name %></strong>
                    <span><%= b.service_name %></span>
                </div>
                <div class="upcoming-date">
                    <strong><%= formatDate(b.booking_date) %></strong>
                    <span><%= timeSlotLabels[b.time_slot] || b.time_slot %></span>
                </div>
                <span class="status-badge status-<%= b.status %>"><%= statusLabels[b.status] %></span>
            </a>
            <% }) %>
        </div>
        <% } %>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
const chartData = <%- JSON.stringify(chartData) %>;
const labels = [];
const values = [];

// Fill in all 30 days
const now = new Date();
for (let i = 29; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    labels.push(d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }));
    const found = chartData.find(c => c.date === dateStr);
    values.push(found ? found.count : 0);
}

const ctx = document.getElementById('bookingsChart');
if (ctx) {
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'RÃ©servations',
                data: values,
                backgroundColor: '<%= site.theme.colors.accent %>44',
                borderColor: '<%= site.theme.colors.accent %>',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: { ticks: { maxTicksLimit: 10 } }
            }
        }
    });
}
</script>
