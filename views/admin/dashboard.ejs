<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-info">
            <p class="stat-value"><%= stats.todayCount %></p>
            <p class="stat-label">RDV aujourd'hui</p>
        </div>
    </div>
    <div class="stat-card stat-card--warning">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-info">
            <p class="stat-value"><%= stats.pendingCount %></p>
            <p class="stat-label">En attente</p>
        </div>
    </div>
    <div class="stat-card stat-card--info">
        <div class="stat-icon">üë•</div>
        <div class="stat-info">
            <p class="stat-value"><%= stats.clientCount %></p>
            <p class="stat-label">Total clients</p>
        </div>
    </div>
    <div class="stat-card stat-card--success">
        <div class="stat-icon">üí∞</div>
        <div class="stat-info">
            <p class="stat-value"><%= parseFloat(stats.monthRevenue).toFixed(0) %>‚Ç¨</p>
            <p class="stat-label">CA du mois</p>
        </div>
    </div>
    <div class="stat-card" style="border-left-color: #f0ad4e;">
        <div class="stat-icon">üí∂</div>
        <div class="stat-info">
            <p class="stat-value"><%= parseFloat(stats.monthForecast).toFixed(0) %>‚Ç¨</p>
            <p class="stat-label">Pr√©visionnel du mois</p>
        </div>
    </div>
    <div class="stat-card" style="border-left-color: #dc3545;">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-info">
            <p class="stat-value"><%= stats.todayCancelled %></p>
            <p class="stat-label">Annul√©(s) aujourd'hui</p>
        </div>
    </div>
</div>

<% if (reminders && reminders.length > 0) { %>
<div class="reminder-panel">
    <div class="reminder-header">
        <h3>üîî Rappels ‚Äî RDV aujourd'hui/demain (<%= reminders.length %>)</h3>
    </div>
    <div class="reminder-list">
        <% const today = new Date().toISOString().split('T')[0]; %>
        <% reminders.forEach(r => { %>
        <div class="reminder-card">
            <div class="reminder-info">
                <div class="reminder-icon"><%= r.service_icon %></div>
                <div>
                    <strong><%= r.first_name %> <%= r.last_name %></strong>
                    <span class="reminder-service"><%= r.service_name %></span>
                    <span class="reminder-date">
                        <%= r.booking_date.toISOString().split('T')[0] === today ? "Aujourd'hui" : 'Demain' %>
                        ‚Äî <%= formatTimeSlot(r.time_slot) %><%= r.time_slot_end ? ' - ' + formatTimeSlot(r.time_slot_end) : '' %>
                    </span>
                </div>
            </div>
            <div class="reminder-actions">
                <% if (!demoMode) { %><a href="tel:<%= r.phone %>" class="btn btn-sm btn-success" title="Appeler">üìû Appeler</a><% } %>
                <a href="/admin/bookings/<%= r.id %>" class="btn btn-sm">Voir</a>
                <form method="POST" action="/admin/bookings/<%= r.id %>/dismiss-reminder" style="display:inline;">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="btn btn-sm <%= r.status === 'pending' ? 'btn-success' : '' %>"><%= r.status === 'pending' ? '‚úì Confirmer' : '‚úì Trait√©' %></button>
                </form>
            </div>
        </div>
        <% }) %>
    </div>
</div>
<% } %>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>R√©servations du mois</h3>
        <canvas id="bookingsChart" height="200"></canvas>
    </div>

    <div class="dashboard-card">
        <h3>Prochains rendez-vous</h3>
        <% if (upcoming.length === 0) { %>
        <p class="empty-state">Aucun rendez-vous √† venir</p>
        <% } else { %>
        <div class="upcoming-list">
            <% upcoming.forEach(b => { %>
            <a href="/admin/bookings/<%= b.id %>" class="upcoming-item">
                <div class="upcoming-icon"><%= b.service_icon %></div>
                <div class="upcoming-info">
                    <strong><%= b.first_name %> <%= b.last_name %></strong>
                    <span><%= b.service_name %></span>
                </div>
                <div class="upcoming-date">
                    <strong><%= formatDate(b.booking_date) %></strong>
                    <span><%= formatTimeSlot(b.time_slot) %><%= b.time_slot_end ? ' - ' + formatTimeSlot(b.time_slot_end) : '' %></span>
                </div>
                <span class="status-badge status-<%= b.status %>"><%= statusLabels[b.status] %></span>
            </a>
            <% }) %>
        </div>
        <% } %>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
const chartData = <%- JSON.stringify(chartData) %>;
const labels = [];
const values = [];

// Fill in all days of current month
const now = new Date();
const year = now.getFullYear();
const month = now.getMonth();
const daysInMonth = new Date(year, month + 1, 0).getDate();
for (let day = 1; day <= daysInMonth; day++) {
    const key = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
    labels.push(String(day));
    const found = chartData.find(c => c.date === key);
    values.push(found ? parseInt(found.count, 10) : 0);
}

const ctx = document.getElementById('bookingsChart');
if (ctx) {
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, ctx.parentElement.offsetHeight || 200);
    gradient.addColorStop(0, '<%= site.theme.colors.accent %>40');
    gradient.addColorStop(1, '<%= site.theme.colors.accent %>00');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'R√©servations',
                data: values,
                backgroundColor: gradient,
                borderColor: '<%= site.theme.colors.accent %>',
                borderWidth: 2.5,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '<%= site.theme.colors.accent %>',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#fff',
                    titleColor: '#333',
                    bodyColor: '#333',
                    borderColor: '<%= site.theme.colors.accent %>44',
                    borderWidth: 1,
                    padding: 10,
                    cornerRadius: 8,
                    displayColors: false,
                    callbacks: {
                        title: function(items) { return items[0].label + '/' + String(month + 1).padStart(2, '0'); },
                        label: function(c) { return c.raw + ' RDV'; }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    suggestedMax: Math.max(...values, 2) + 1,
                    ticks: { stepSize: 1, color: '#aaa', font: { size: 11 } },
                    grid: { color: '#f0f0f0', drawBorder: false },
                    border: { display: false }
                },
                x: {
                    ticks: { maxTicksLimit: 8, color: '#aaa', font: { size: 11 } },
                    grid: { display: false },
                    border: { display: false }
                }
            }
        }
    });
}
</script>
